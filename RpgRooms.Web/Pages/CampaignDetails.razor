@page "/campaigns/{id:guid}"
@using Microsoft.AspNetCore.Components.Web
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@using RpgRooms.Core.Application.DTOs
@using System.Net
@using Microsoft.JSInterop

<h3>@campaign?.Name</h3>
@if (loadFailed)
{
    <p class="text-danger">Falha ao carregar a campanha.</p>
}
else if (campaign is null)
{
    <p>Carregando...</p>
}
else
{
    <p>@campaign.Description</p>
    <p>Status: <b>@campaign.Status</b> — @(campaign.IsRecruiting ? "Recrutando" : "Fechada")</p>

    @if (isGm)
    {
        <button class="btn" @onclick="ToggleRecruitment">Alternar Recrutamento</button>
        <button class="btn" @onclick="FinalizeCampaign" style="margin-left:8px">Finalizar Campanha</button>

        <h4>Solicitações Pendentes</h4>
        @if (joinRequests.Count == 0)
        {
            <p>Nenhuma solicitação.</p>
        }
        else
        {
            @foreach (var r in joinRequests)
            {
                <div>@r.UserId (@r.Message)
                    <button class="btn" @onclick="() => Approve(r.Id)">Aprovar</button>
                    <button class="btn" @onclick="() => Reject(r.Id)" style="margin-left:4px">Rejeitar</button>
                </div>
            }
        }

        <h4>Membros</h4>
        @if (members.Count == 0)
        {
            <p>Nenhum membro.</p>
        }
        else
        {
            @foreach (var m in members)
            {
                <div>@m.UserId
                    <button class="btn" @onclick="() => Kick(m.UserId)" style="margin-left:4px">Remover</button>
                </div>
            }
        }
    }
    else if (campaign.IsRecruiting)
    {
        <button class="btn" @onclick="SendJoinRequest">Solicitar Participação</button>
    }

    <hr />
    <h4>Chat</h4>
    <label>Nome para exibir</label>
    <input @bind="displayName" />
    <label style="margin-left:8px"><input type="checkbox" @bind="sentAsCharacter" /> Enviar como personagem</label>

    <div class="chat-box">
        @foreach (var m in messages)
        {
            <div><b>@m.DisplayName</b>: @m.Content</div>
        }
    </div>

    <input @bind="message" @onkeydown="HandleKey" placeholder="Digite uma mensagem..." />
    <button class="btn" @onclick="Send">Enviar</button>
}

@code {
    [Parameter] public Guid id { get; set; }

    Campaign? campaign;
    List<ChatMessageDto> messages = new();
    List<JoinRequest> joinRequests = new();
    List<CampaignMember> members = new();
    string message = string.Empty;
    string displayName = string.Empty;
    bool sentAsCharacter;
    bool isGm;
    bool loadFailed;

    [CascadingParameter] public Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var campaignResponse = await Http.GetAsync($"/api/campaigns/{id}");
            if (campaignResponse.StatusCode == HttpStatusCode.Unauthorized)
            {
                Nav.NavigateTo($"/login?returnUrl=/campaigns/{id}", true);
                return;
            }
            campaignResponse.EnsureSuccessStatusCode();
            campaign = await campaignResponse.Content.ReadFromJsonAsync<Campaign>();

            var messagesResponse = await Http.GetAsync($"/api/campaigns/{id}/messages");
            if (messagesResponse.IsSuccessStatusCode)
            {
                messages = await messagesResponse.Content.ReadFromJsonAsync<List<ChatMessageDto>>() ?? new();
            }

            await RefreshIsGm();
            if (isGm)
            {
                await LoadJoinRequests();
                await LoadMembers();
            }
        }
        catch
        {
            loadFailed = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var user = (await AuthStateTask).User;
            if (user.Identity?.IsAuthenticated == true)
            {
                try
                {
                    await JS.InvokeVoidAsync("chat.join", id.ToString(), DotNetObjectReference.Create(this));
                }
                catch (JSException)
                {
                    // Ignora falhas de conexão do SignalR
                }
            }
        }
    }

    private async Task RefreshIsGm()
    {
        var c = await Http.GetFromJsonAsync<Campaign>($"/api/campaigns/{id}");
        var me = (await AuthStateTask)!.User.Identity!.Name;
        isGm = c?.OwnerUserId == me;
    }

    private async Task LoadJoinRequests()
    {
        joinRequests = await Http.GetFromJsonAsync<List<JoinRequest>>($"/api/campaigns/{id}/join-requests") ?? new();
    }

    private async Task LoadMembers()
    {
        members = await Http.GetFromJsonAsync<List<CampaignMember>>($"/api/campaigns/{id}/members") ?? new();
    }

    [JSInvokable]
    public Task OnReceiveMessage(ChatMessageDto dto)
    {
        messages.Add(dto);
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnSystemNotice(string text)
    {
        messages.Add(new ChatMessageDto(Guid.Empty, "Sistema", text, false));
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ToggleRecruitment()
    {
        var res = await Http.PutAsync($"/api/campaigns/{id}/recruitment/toggle", null);
        res.EnsureSuccessStatusCode();
        campaign = await Http.GetFromJsonAsync<Campaign>($"/api/campaigns/{id}");
    }

    private async Task FinalizeCampaign()
    {
        var res = await Http.PutAsync($"/api/campaigns/{id}/finalize", null);
        res.EnsureSuccessStatusCode();
        campaign = await Http.GetFromJsonAsync<Campaign>($"/api/campaigns/{id}");
        await RefreshIsGm();
    }

    private async Task SendJoinRequest()
    {
        var res = await Http.PostAsJsonAsync($"/api/campaigns/{id}/join-requests", new { Message = "Gostaria de participar" });
        res.EnsureSuccessStatusCode();
    }

    private async Task Approve(Guid reqId)
    {
        var res = await Http.PutAsync($"/api/campaigns/{id}/join-requests/{reqId}/approve", null);
        res.EnsureSuccessStatusCode();
        await LoadJoinRequests();
        await LoadMembers();
    }

    private async Task Reject(Guid reqId)
    {
        var res = await Http.PutAsync($"/api/campaigns/{id}/join-requests/{reqId}/reject", null);
        res.EnsureSuccessStatusCode();
        await LoadJoinRequests();
    }

    private async Task Kick(string userId)
    {
        var res = await Http.DeleteAsync($"/api/campaigns/{id}/members/{userId}");
        res.EnsureSuccessStatusCode();
        await LoadMembers();
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(message)) return;
        await JS.InvokeVoidAsync("chat.send", id.ToString(), displayName, message, sentAsCharacter);
        message = string.Empty;
    }

    private async Task HandleKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await Send();
    }
}
