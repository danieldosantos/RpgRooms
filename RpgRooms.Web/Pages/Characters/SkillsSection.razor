@using RpgRooms.Core.Domain.Entities
@using RpgRooms.Core.Application.Services
@inject IJSRuntime JS
<div class="rpg-section">
  <h4>Per√≠cias</h4>
  @foreach (var skill in skills)
  {
      var proficient = Character.SkillProficiencies.Any(p => p.Name == skill.Name);
      <div>
          @if(!IsReadOnly)
          {
              <input type="checkbox" checked="@proficient" @onchange="e => Toggle(skill.Name, (bool)e.Value)" />
          }
          <span>@skill.Display (@Character.GetSkillValue(skill.Name))</span>
          <button type="button" class="btn" @onclick="() => RollSkill(skill)">Roll</button>
      </div>
  }
</div>

@code {
  [Parameter] public Character Character { get; set; } = default!;
  [Parameter] public bool IsReadOnly { get; set; }
  [Parameter] public Guid CampaignId { get; set; }

  record Skill(string Name, string Display, string Ability);
  Skill[] skills = new[] {
      new Skill("Acrobatics","Acrobatics (DEX)","DEX"),
      new Skill("Animal Handling","Animal Handling (WIS)","WIS"),
      new Skill("Arcana","Arcana (INT)","INT"),
      new Skill("Athletics","Athletics (STR)","STR"),
      new Skill("Deception","Deception (CHA)","CHA"),
      new Skill("History","History (INT)","INT"),
      new Skill("Insight","Insight (WIS)","WIS"),
      new Skill("Intimidation","Intimidation (CHA)","CHA"),
      new Skill("Investigation","Investigation (INT)","INT"),
      new Skill("Medicine","Medicine (WIS)","WIS"),
      new Skill("Nature","Nature (INT)","INT"),
      new Skill("Perception","Perception (WIS)","WIS"),
      new Skill("Performance","Performance (CHA)","CHA"),
      new Skill("Persuasion","Persuasion (CHA)","CHA"),
      new Skill("Religion","Religion (INT)","INT"),
      new Skill("Sleight of Hand","Sleight of Hand (DEX)","DEX"),
      new Skill("Stealth","Stealth (DEX)","DEX"),
      new Skill("Survival","Survival (WIS)","WIS")
  };
  void Toggle(string name, bool value)
  {
      var prof = Character.SkillProficiencies.FirstOrDefault(p => p.Name == name);
      if (value && prof == null) Character.SkillProficiencies.Add(new SkillProficiency { Name = name });
      if (!value && prof != null) Character.SkillProficiencies.Remove(prof);
  }

  async Task RollSkill(Skill skill)
  {
      var expr = $"1d20 + {skill.Ability}";
      if (Character.SkillProficiencies.Any(p => p.Name == skill.Name))
          expr += " + PB";
      var result = DiceRoller.Roll(expr, Character);
      var message = $"{Character.Name} testa {skill.Display}: {result.Total} ({result.Detail})";
      await JS.InvokeVoidAsync("chat.send", CampaignId.ToString(), Character.Name, message, true);
  }
}
